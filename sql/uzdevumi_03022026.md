Apakšvaicājumi (nested SELECT) — teorija + piemēri + uzdevumi

==============================================

0. Kas ir apakšvaicājums?

---

Apakšvaicājums ir `SELECT`, kas atrodas cita `SELECT` iekšā. To izmanto, lai:

- atrastu salīdzināšanas vērtību (piem., vidējo cenu),
- iegūtu sarakstu (piem., ID sarakstu ar `IN`),
- pārbaudītu eksistenci (`EXISTS`),
- izveidotu “pagaidu tabulu” (`FROM (SELECT ...)`).

---

1. Kur parasti liek apakšvaicājumu?

---

1. `WHERE` daļā (visbiežāk)

```sql
SELECT ProductName, Price
FROM Products
WHERE Price > (
  SELECT AVG(Price)
  FROM Products
);
```

2. `WHERE ... IN (...)`

```sql
SELECT CustomerName
FROM Customers
WHERE CustomerID IN (
  SELECT CustomerID
  FROM Orders
);
```

3. `WHERE EXISTS (...)`

```sql
SELECT CustomerName
FROM Customers
WHERE EXISTS (
  SELECT 1
  FROM Orders
  WHERE Orders.CustomerID = Customers.CustomerID
);
```

4. `FROM (SELECT ...)` (atvasināta tabula)

```sql
SELECT SupplierName, ProductCount
FROM (
  SELECT SupplierID, COUNT(*) AS ProductCount
  FROM Products
  GROUP BY SupplierID
) t
JOIN Suppliers ON Suppliers.SupplierID = t.SupplierID;
```

---

2. Korelēts apakšvaicājums (correlated subquery)

---

Korelēts apakšvaicājums izmanto vērtību no ārējā vaicājuma. Tas bieži ir vajadzīgs “katrai rindai atsevišķi” tipa uzdevumos.

Piemērs: katrai kategorijai atstāt tikai dārgāko produktu (ar iespējamiem “vienādi dārgi” gadījumiem).

```sql
SELECT
  Products.ProductName,
  Products.Price
FROM Products
WHERE Products.Price = (
  SELECT MAX(Products2.Price)
  FROM Products Products2
  WHERE Products2.CategoryID = Products.CategoryID
);
```

---

3. Biežākās kļūdas

---

- Ja `WHERE Price = (SELECT ...)` apakšvaicājums atgriež vairāk nekā 1 rindu, būs kļūda. Tad parasti vajag `IN` vai jānodrošina, ka atgriežas tieši viena vērtība.
- `IN (SELECT ...)` var dot negaidītus rezultātus, ja apakšvaicājumā ir `NULL`. Ja rodas šaubas, izmanto `EXISTS`.
- Ja `EXISTS` nav sasaistīts ar ārējo vaicājumu (`WHERE Orders.CustomerID = Customers.CustomerID`), tad tas bieži kļūst par “vienmēr true/false”.

---

4. Tipiskie JOIN ceļi (špikeris uzdevumiem)

---

- Products → Categories (Products.CategoryID = Categories.CategoryID)
- Products → Suppliers (Products.SupplierID = Suppliers.SupplierID)
- Orders → Customers (Orders.CustomerID = Customers.CustomerID)
- Orders → Employees (Orders.EmployeeID = Employees.EmployeeID)
- Orders → Shippers (Orders.ShipperID = Shippers.ShipperID)
- OrderDetails → Orders (OrderDetails.OrderID = Orders.OrderID)
- OrderDetails → Products (OrderDetails.ProductID = Products.ProductID)

---

Uzdevumi (ar apakšvaicājumiem)

---

Noteikums: katrā uzdevumā obligāti jābūt vismaz vienam apakšvaicājumam.

1. Virs vidējās cenas (vienkāršākais — skalārs apakšvaicājums)

Parādi produktus, kuru cena ir lielāka par visu produktu vidējo cenu.

Izvada:

- ProductName
- Price

Nosacījums:

- `Price > (SELECT AVG(Price) ...)`

Sakārto pēc cenas dilstoši.

---

2. Klienti, kuriem ir vismaz 1 pasūtījums (IN apakšvaicājums)

Parādi klientus, kuri ir veikuši vismaz vienu pasūtījumu.

Izvada:

- CustomerName
- Country

Nosacījums:

- `CustomerID IN (SELECT CustomerID FROM Orders ...)`

Sakārto pēc valsts A–Z un pēc klienta nosaukuma A–Z.

---

3. Katras kategorijas dārgākie produkti (korelēts apakšvaicājums)

Atrodi katras kategorijas dārgāko produktu(-us). Ja vairāk nekā vienam produktam kategorijā ir vienāda maksimālā cena, parādi visus.

Izvada:

- CategoryName
- ProductName
- Price

Norāde:

- salīdzini `Products.Price` ar `(
  SELECT MAX(Price)
  FROM Products ...
  WHERE ... = Products.CategoryID
)`

Sakārto pēc kategorijas nosaukuma A–Z, pēc cenas dilstoši.

---

4. Piegādātāji ar vairāk produktiem nekā vidēji (apakšvaicājums apakšvaicājumā)

Parādi piegādātājus, kuriem produktu skaits ir lielāks nekā vidējais produktu skaits piegādātājam.

Izvada:

- SupplierName
- produktu skaitu

Norāde:

- iekšējais apakšvaicājums: produktu skaits katram piegādātājam (`GROUP BY SupplierID`)
- ārējais salīdzinājums: `ProductCount > (SELECT AVG(ProductCount) FROM (SELECT ... ) t)`

Sakārto pēc produktu skaita dilstoši.

---

5. “Visu kategoriju” klients (grūtākais — NOT EXISTS / relational division)

Atrodi klientus, kuri ir pasūtījuši vismaz vienu produktu no katras kategorijas.

Izvada:

- CustomerName
- Country

Norāde (ideja):

- atrodi klientus, kuriem **neeksistē** tāda kategorija, no kuras viņi nav neko pasūtījuši:
  - `NOT EXISTS (SELECT ... FROM Categories WHERE NOT EXISTS (SELECT ... FROM Orders/OrderDetails/Products ...))`

Sakārto pēc valsts A–Z un klienta nosaukuma A–Z.
